// share.js - ÂàÜ‰∫´È°µÈù¢ÈÄªËæë
class ShareApp {
    constructor() {
        this.sessionId = null;
        this.chatMessages = document.getElementById('chatMessages');
        this.loadingOverlay = document.getElementById('loadingOverlay');
        this.thinkingFlow = new ThinkingFlow(this, 'shareApp'); // ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂÆû‰æãÂíåÂêçÁß∞
        
        this.init();
    }
    
    async init() {
        try {
            // ‰ªéURLÂèÇÊï∞Ëé∑Âèñ‰ºöËØùID
            this.sessionId = this.getSessionIdFromUrl();
            
            if (!this.sessionId) {
                this.showError('Êó†ÊïàÁöÑÂàÜ‰∫´ÈìæÊé•', 'Áº∫Â∞ë‰ºöËØùIDÂèÇÊï∞');
                return;
            }
            
            // Âä†ËΩΩÈÖçÁΩÆ
            this.showLoading('Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆ...');
            if (!window.configManager.isLoaded) {
                await window.configManager.loadConfig();
            }
            
            // Âä†ËΩΩÂàÜ‰∫´ÁöÑËÅäÂ§©ËÆ∞ÂΩï
            await this.loadSharedChat();
            
        } catch (error) {
            console.error('‚ùå ÂàÜ‰∫´È°µÈù¢ÂàùÂßãÂåñÂ§±Ë¥•:', error);
            this.showError('Âä†ËΩΩÂ§±Ë¥•', 'Êó†Ê≥ïÂä†ËΩΩÂàÜ‰∫´ÁöÑÂØπËØùËÆ∞ÂΩï');
        }
    }
    
    getSessionIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('session');
    }
    
    async loadSharedChat() {
        try {
            this.showLoading('Ê≠£Âú®Âä†ËΩΩÂØπËØùËÆ∞ÂΩï...');
            
            const apiUrl = window.configManager.getFullApiUrl(`/api/share/${encodeURIComponent(this.sessionId)}`);
            
            const response = await fetch(apiUrl);
            
            if (!response.ok) {
                if (response.status === 404) {
                    this.showError('ÂØπËØù‰∏çÂ≠òÂú®', 'Êú™ÊâæÂà∞ËØ•‰ºöËØùÁöÑËÅäÂ§©ËÆ∞ÂΩïÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§Êàñ‰ºöËØùIDÊó†Êïà');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return;
            }
            
            const result = await response.json();
            
            if (!result.success || !result.data || result.data.length === 0) {
                this.showEmptyState();
                return;
            }
            
            // ÊòæÁ§∫ËÅäÂ§©ËÆ∞ÂΩï
            this.displayChatHistory(result.data);
            
            // Êõ¥Êñ∞È°µÈù¢Ê†áÈ¢ò
            document.title = `ÂàÜ‰∫´ÁöÑÂØπËØù (${result.total_records}Êù°Ê∂àÊÅØ) - MCP Web Êô∫ËÉΩÂä©Êâã`;
            
            this.hideLoading();
            
        } catch (error) {
            console.error('‚ùå Âä†ËΩΩÂàÜ‰∫´ËÅäÂ§©ËÆ∞ÂΩïÂ§±Ë¥•:', error);
            this.showError('Âä†ËΩΩÂ§±Ë¥•', `Êó†Ê≥ïËé∑ÂèñËÅäÂ§©ËÆ∞ÂΩï: ${error.message}`);
        }
    }
    
    displayChatHistory(records) {
        this.chatMessages.innerHTML = '';
        
        // Ê∑ªÂä†ÂàÜ‰∫´‰ø°ÊÅØÂ§¥ÈÉ®
        this.addShareHeader(records.length);
        
        // ÊåâÂØπËØùIDÂàÜÁªÑÊòæÁ§∫
        const conversationGroups = this.groupByConversation(records);
        
        conversationGroups.forEach((conversation, index) => {
            // Ê∑ªÂä†ÂØπËØùÂàÜÈöîÁ¨¶ÔºàÂ¶ÇÊûúÊúâÂ§ö‰∏™ÂØπËØùÔºâ
            if (conversationGroups.length > 1) {
                this.addConversationSeparator(index + 1, conversation.length);
            }
            
            conversation.forEach(record => {
                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                this.addUserMessage(record.user_input, record.created_at);
                
                // ÈáçÁé∞ÊÄùÁª¥Èìæ
                if (record.mcp_tools_called && record.mcp_tools_called.length > 0) {
                    this.reproduceThinkingFlow(record);
                }
                
                // Ê∑ªÂä†AIÂõûÂ§ç
                if (record.ai_response) {
                    this.addAIMessage(record.ai_response, record.ai_timestamp || record.created_at);
                }
            });
        });
        
        // ÊªöÂä®Âà∞È°∂ÈÉ®
        this.chatMessages.scrollTop = 0;
    }
    
    groupByConversation(records) {
        const groups = new Map();
        
        records.forEach(record => {
            const convId = record.conversation_id;
            if (!groups.has(convId)) {
                groups.set(convId, []);
            }
            groups.get(convId).push(record);
        });
        
        // ËΩ¨Êç¢‰∏∫Êï∞ÁªÑÂπ∂ÊåâÂØπËØùIDÊéíÂ∫è
        return Array.from(groups.values()).sort((a, b) => {
            return a[0].conversation_id - b[0].conversation_id;
        });
    }
    
    addShareHeader(totalMessages) {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'share-header';
        headerDiv.innerHTML = `
            <div class="share-header-content">
                <div class="share-icon">üîó</div>
                <h2>ÂàÜ‰∫´ÁöÑÂØπËØùËÆ∞ÂΩï</h2>
                <p>‰ºöËØùID: <code>${this.escapeHtml(this.sessionId)}</code></p>
                <p>ÂÖ± ${totalMessages} Êù°ÂØπËØùËÆ∞ÂΩï</p>
                <div class="share-timestamp">
                    ÂàÜ‰∫´Êó∂Èó¥: ${new Date().toLocaleString('zh-CN')}
                </div>
            </div>
        `;
        
        // Ê∑ªÂä†Ê†∑Âºè
        if (!document.getElementById('share-header-styles')) {
            const styles = document.createElement('style');
            styles.id = 'share-header-styles';
            styles.textContent = `
                .share-header {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 1rem 0.75rem;
                    margin-bottom: 0.75rem;
                    text-align: center;
                }
                .share-header-content h2 {
                    margin: 0.25rem 0;
                    font-size: 1.2rem;
                }
                .share-header-content p {
                    margin: 0.15rem 0;
                    opacity: 0.9;
                    font-size: 0.9rem;
                }
                .share-header-content code {
                    background: rgba(255, 255, 255, 0.2);
                    padding: 0.15rem 0.3rem;
                    border-radius: 3px;
                    font-family: monospace;
                    font-size: 0.85rem;
                }
                .share-icon {
                    font-size: 1.5rem;
                    margin-bottom: 0.25rem;
                }
                .share-timestamp {
                    font-size: 0.8rem;
                    opacity: 0.8;
                    margin-top: 0.5rem;
                }
                .conversation-separator {
                    background: #f7fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    padding: 1rem;
                    margin: 1.5rem 0;
                    text-align: center;
                    color: #718096;
                }
                .tools-info {
                    background: #f0f9ff;
                    border: 1px solid #bae6fd;
                    border-radius: 8px;
                    padding: 1rem;
                    margin: 0.5rem 0;
                }
                .tools-info-header {
                    font-weight: 600;
                    color: #0369a1;
                    margin-bottom: 0.5rem;
                }
                .tool-item {
                    background: white;
                    border-radius: 4px;
                    padding: 0.5rem;
                    margin: 0.25rem 0;
                    font-size: 0.9rem;
                    border: 1px solid #e5e7eb;
                }
                .tool-header {
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }
                .tool-icon {
                    font-size: 1rem;
                }
                .tool-info {
                    flex: 1;
                }
                .tool-name {
                    font-weight: 500;
                    color: #1e40af;
                    margin: 0;
                }
                .tool-status {
                    color: #6b7280;
                    font-size: 0.8rem;
                    margin: 0;
                }
                .tool-result-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-top: 0.5rem;
                    padding: 0.25rem 0;
                    border-top: 1px solid #f3f4f6;
                }
                .tool-result-size {
                    font-size: 0.75rem;
                    color: #9ca3af;
                }
                .tool-result-toggle {
                    background: none;
                    border: none;
                    color: #3b82f6;
                    cursor: pointer;
                    font-size: 0.75rem;
                    display: flex;
                    align-items: center;
                    gap: 0.25rem;
                    padding: 0.25rem 0.5rem;
                    border-radius: 4px;
                    transition: background-color 0.2s;
                }
                .tool-result-toggle:hover {
                    background-color: #f3f4f6;
                }
                .tool-result-content {
                    margin-top: 0.5rem;
                    max-height: none;
                    overflow: hidden;
                    transition: max-height 0.3s ease;
                }
                .tool-result-content.collapsed {
                    max-height: 0;
                }
                .tool-result-content pre {
                    background: #f8fafc;
                    border: 1px solid #e2e8f0;
                    border-radius: 4px;
                    padding: 0.75rem;
                    margin: 0;
                    font-size: 0.8rem;
                    line-height: 1.4;
                    overflow-x: auto;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                }
                .tool-result-content table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 0.5rem 0;
                    font-size: 0.8rem;
                }
                .tool-result-content table th,
                .tool-result-content table td {
                    border: 1px solid #d1d5db;
                    padding: 0.5rem;
                    text-align: left;
                }
                .tool-result-content table th {
                    background-color: #f9fafb;
                    font-weight: 600;
                }
                .error-text {
                    color: #dc2626;
                    background: #fef2f2;
                    border: 1px solid #fecaca;
                    border-radius: 4px;
                    padding: 0.5rem;
                    font-size: 0.8rem;
                }
                .message-timestamp {
                    font-size: 0.8rem;
                    color: #9ca3af;
                    margin-top: 0.5rem;
                }
            `;
            document.head.appendChild(styles);
        }
        
        this.chatMessages.appendChild(headerDiv);
    }
    
    addConversationSeparator(conversationNumber, messageCount) {
        const separatorDiv = document.createElement('div');
        separatorDiv.className = 'conversation-separator';
        separatorDiv.innerHTML = `
            <strong>ÂØπËØù ${conversationNumber}</strong>
            <span style="margin-left: 1rem; font-size: 0.9rem;">${messageCount} Êù°Ê∂àÊÅØ</span>
        `;
        this.chatMessages.appendChild(separatorDiv);
    }
    
    addUserMessage(content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        
        let renderedContent;
        try {
            if (typeof marked !== 'undefined') {
                renderedContent = marked.parse(content);
            } else {
                renderedContent = this.escapeHtml(content);
            }
        } catch (error) {
            console.warn('Áî®Êà∑Ê∂àÊÅØMarkdownÊ∏≤ÊüìÈîôËØØ:', error);
            renderedContent = this.escapeHtml(content);
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${renderedContent}
                <div class="message-timestamp">
                    ${this.formatTimestamp(timestamp)}
                </div>
            </div>
        `;
        
        this.chatMessages.appendChild(messageDiv);
    }
    
    addAIMessage(content, timestamp) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai';
        
        let renderedContent;
        try {
            if (typeof marked !== 'undefined') {
                renderedContent = marked.parse(content);
            } else {
                renderedContent = this.escapeHtml(content);
            }
        } catch (error) {
            console.warn('AIÊ∂àÊÅØMarkdownÊ∏≤ÊüìÈîôËØØ:', error);
            renderedContent = this.escapeHtml(content);
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${renderedContent}
                <div class="message-timestamp">
                    ${this.formatTimestamp(timestamp)}
                </div>
            </div>
        `;
        
        this.chatMessages.appendChild(messageDiv);
    }
    
    scrollToBottom() {
        // ÂàÜ‰∫´È°µÈù¢ÈÄöÂ∏∏‰∏çÈúÄË¶ÅÂÉèËÅäÂ§©Á™óÂè£ÈÇ£Ê†∑ÊåÅÁª≠ÊªöÂä®Âà∞Â∫ïÈÉ®Ôºå
        // ‰ΩÜ ThinkingFlow Ê®°ÂùóÈúÄË¶ÅËøô‰∏™ÊñπÊ≥ïÂ≠òÂú®„ÄÇ
        // ÂèØ‰ª•ÁïôÁ©∫ÊàñÊ∑ªÂä†‰∏Ä‰∏™ËΩªÂæÆÁöÑÊªöÂä®Ë°å‰∏∫„ÄÇ
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    reproduceThinkingFlow(record) {
        // 1. ÂàõÂª∫ÊÄùÁª¥ÊµÅ
        this.thinkingFlow.createThinkingFlow();

        // 2. Êõ¥Êñ∞ÂàÜÊûêÈò∂ÊÆµ
        this.thinkingFlow.updateThinkingStage('analyzing', 'AI Ê≠£Âú®ÂàÜÊûê', 'Â∑≤ÂÆåÊàêÂàÜÊûêÔºåÂáÜÂ§áÊâßË°åÂ∑•ÂÖ∑„ÄÇ');

        // 3. ËÆ°ÂàíÂ∑•ÂÖ∑
        const toolCount = record.mcp_tools_called.length;
        this.thinkingFlow.updateThinkingStage(
            'tools_planned',
            `ÂÜ≥ÂÆö‰ΩøÁî® ${toolCount} ‰∏™Â∑•ÂÖ∑`,
            'Â∑•ÂÖ∑Â∑≤ÊâßË°å„ÄÇ',
            { toolCount: toolCount }
        );

        // 4. Ê∑ªÂä†Âπ∂ÂÆåÊàêÊØè‰∏™Â∑•ÂÖ∑
        record.mcp_tools_called.forEach((tool, index) => {
            const result = record.mcp_results && record.mcp_results[index];
            const toolData = {
                tool_id: `${record.id}-${index}`,
                tool_name: tool.tool_name,
                result: result ? result.result : '',
                error: result ? result.error : ''
            };

            this.thinkingFlow.addToolToThinking(toolData);
            const status = result && result.success ? 'completed' : 'error';
            this.thinkingFlow.updateToolInThinking(toolData, status);
        });

        // 5. ÂÆåÊàêÊÄùÁª¥ÊµÅ
        this.thinkingFlow.completeThinkingFlow('success');
        
        // 6. ÈªòËÆ§ÊäòÂè†ÊÄùÁª¥Èìæ
        const currentFlow = this.thinkingFlow.getCurrentFlow();
        if (currentFlow) {
            this.thinkingFlow.toggleThinkingFlow(currentFlow.id, true);
        }
    }


    
    formatTimestamp(timestamp) {
        if (!timestamp) return '';
        
        try {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        } catch (error) {
            console.warn('Êó∂Èó¥Êà≥Ê†ºÂºèÂåñÈîôËØØ:', error);
            return timestamp;
        }
    }
    
    // Êö¥Èú≤ÁªôÂÖ®Â±ÄÔºå‰ª•‰æøonclickÂèØ‰ª•Ë∞ÉÁî®
    toggleThinkingFlow(flowId, forceCollapse = false) {
        this.thinkingFlow.toggleThinkingFlow(flowId, forceCollapse);
    }

    
    // Ê†ºÂºèÂåñÊï∞ÊçÆÂ§ßÂ∞èÊòæÁ§∫
    formatDataSize(bytes) {
        if (bytes < 1024) return bytes + ' Â≠óÁ¨¶';
        const kb = (bytes / 1024).toFixed(2);
        return `${kb} KB`;
    }
    
    // Ê†ºÂºèÂåñÂ∑•ÂÖ∑ÁªìÊûú
    formatToolResult(result) {
        // Â∞ùËØïËß£Êûê‰∏∫JSONÂπ∂ÁæéÂåñÊòæÁ§∫
        try {
            const parsed = JSON.parse(result);
            if (typeof parsed === 'object') {
                return this.formatJsonResult(parsed);
            }
        } catch (e) {
            // ‰∏çÊòØJSONÔºåÁªßÁª≠ÂÖ∂‰ªñÊ†ºÂºèÂåñ
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´Ë°®Ê†ºÊï∞ÊçÆ
        if (this.looksLikeTable(result)) {
            return this.formatTableResult(result);
        }
        
        // ÊôÆÈÄöÊñáÊú¨ÔºåÁ°Æ‰øùÊ≠£Á°ÆËΩ¨‰πâ
        return `<pre>${this.escapeHtml(result)}</pre>`;
    }
    
    formatJsonResult(obj) {
        // ÁÆÄÂçïÁöÑJSONÁæéÂåñÊòæÁ§∫
        return `<pre>${this.escapeHtml(JSON.stringify(obj, null, 2))}</pre>`;
    }
    
    looksLikeTable(text) {
        // ÁÆÄÂçïÊ£ÄÊµãÊòØÂê¶ÂåÖÂê´Ë°®Ê†ºÊ†áËÆ∞
        return text.includes('|') && text.includes('---') || 
               text.includes('\t') && text.split('\n').length > 3;
    }
    
    formatTableResult(text) {
        // Â¶ÇÊûúÊòØmarkdownË°®Ê†ºÔºåÂ∞ùËØïËΩ¨Êç¢‰∏∫HTMLË°®Ê†º
        const lines = text.split('\n');
        
        // Êü•ÊâæË°®Ê†ºÊ†áÈ¢òË°åÂíåÂàÜÈöîË°å
        let tableStart = -1;
        let headerIndex = -1;
        let separatorIndex = -1;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.includes('|') && line.split('|').length > 2) {
                if (headerIndex === -1) {
                    headerIndex = i;
                } else if (separatorIndex === -1 && line.includes('---')) {
                    separatorIndex = i;
                    tableStart = headerIndex;
                    break;
                }
            }
        }
        
        if (tableStart >= 0 && separatorIndex > tableStart) {
            // ÊûÑÂª∫HTMLË°®Ê†º
            let tableHtml = '<table>';
            
            // Ê∑ªÂä†Ë°®Â§¥
            const headerCells = lines[headerIndex].split('|').map(cell => cell.trim()).filter(cell => cell);
            if (headerCells.length > 0) {
                tableHtml += '<thead><tr>';
                headerCells.forEach(cell => {
                    tableHtml += `<th>${this.escapeHtml(cell)}</th>`;
                });
                tableHtml += '</tr></thead>';
            }
            
            // Ê∑ªÂä†Ë°®Ê†ºÊï∞ÊçÆ
            tableHtml += '<tbody>';
            let i;
            for (i = separatorIndex + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.includes('|')) {
                    const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                    if (cells.length > 0) {
                        tableHtml += '<tr>';
                        cells.forEach(cell => {
                            tableHtml += `<td>${this.escapeHtml(cell)}</td>`;
                        });
                        tableHtml += '</tr>';
                    }
                } else if (line === '') {
                    continue;
                } else {
                    break; // Ë°®Ê†ºÁªìÊùü
                }
            }
            tableHtml += '</tbody></table>';
            
            // Â¶ÇÊûúË°®Ê†ºÂâçÂêéËøòÊúâÂÖ∂‰ªñÂÜÖÂÆπÔºå‰πüË¶ÅÊòæÁ§∫
            const beforeTable = lines.slice(0, headerIndex).join('\n').trim();
            const afterTable = lines.slice(i).join('\n').trim()
            
            let result = '';
            if (beforeTable) {
                result += `<pre>${this.escapeHtml(beforeTable)}</pre>`;
            }
            result += tableHtml;
            if (afterTable) {
                result += `<pre>${this.escapeHtml(afterTable)}</pre>`;
            }
            
            return result || `<pre>${this.escapeHtml(text)}</pre>`;
        }
        
        // ‰∏çÊòØÊ†áÂáÜË°®Ê†ºÔºåËøîÂõûÊôÆÈÄöÊ†ºÂºè
        return `<pre>${this.escapeHtml(text)}</pre>`;
    }
    
    showError(title, message) {
        this.hideLoading();
        this.chatMessages.innerHTML = `
            <div class="error-message">
                <div class="error-icon">‚ùå</div>
                <h2>${this.escapeHtml(title)}</h2>
                <p>${this.escapeHtml(message)}</p>
                <p><a href="index.html">ËøîÂõûÈ¶ñÈ°µ</a></p>
            </div>
        `;
    }
    
    showEmptyState() {
        this.hideLoading();
        this.chatMessages.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">üí¨</div>
                <h2>ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï</h2>
                <p>ËØ•‰ºöËØùËøòÊ≤°Êúâ‰ªª‰ΩïÂØπËØùËÆ∞ÂΩï</p>
                <p><a href="index.html">ÂºÄÂßãÊñ∞ÂØπËØù</a></p>
            </div>
        `;
    }
    
    showLoading(text = 'Âä†ËΩΩ‰∏≠...') {
        this.loadingOverlay.style.display = 'flex';
        this.loadingOverlay.querySelector('div').textContent = text;
    }
    
    hideLoading() {
        this.loadingOverlay.style.display = 'none';
    }
    
    escapeHtml(text) {
        if (text === null || text === undefined) {
            return '';
        }
        return text.toString()
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
    }
}

// ÂÆû‰æãÂåñÂπ∂ÂàùÂßãÂåñ
const shareApp = new ShareApp();

// Â∞Ü ShareApp ÁöÑÊñπÊ≥ïÊö¥Èú≤Âà∞ÂÖ®Â±ÄÔºå‰ª•‰æø HTML ‰∏≠ÁöÑ onclick ÂèØ‰ª•Ë∞ÉÁî®
window.shareApp = shareApp;